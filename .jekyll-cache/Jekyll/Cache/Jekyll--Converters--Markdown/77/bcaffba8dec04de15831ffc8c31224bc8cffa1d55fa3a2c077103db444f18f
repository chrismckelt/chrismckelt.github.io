I"ş<p>This is a quick post to show how to get PowerShell with <a href="http://codebetter.com/jameskovacs/2010/04/12/psake-v4-00/">PSAKE</a> to run <a href="http://specflow.org/">Specflow</a> acceptance tests on the build server using <a href="http://www.gallio.org/">Gallio</a>.</p>

<p><a href="https://github.com/chrismckelt/PS-Sake-BuildScripts" title="https://github.com/chrismckelt/PS-Sake-BuildScripts">https://github.com/chrismckelt/PS-Sake-BuildScripts</a></p>

<p>Â </p>

<p>The folder with our build scripts looks like this</p>

<p>Â </p>

<p><a href="http://www.mckelt.com/image.axd?picture=image_38.png"><img src="https://raw.githubusercontent.com/chrismckelt/chrismckelt.github.io/master/_posts/posts/images//image.axd?picture=image_thumb_38.png" alt="image" title="image" /></a></p>

<p>Â </p>

<p>The environments folder contains all of the configuration files for each environment</p>

<p>Â </p>

<p><a href="http://www.mckelt.com/image.axd?picture=image_34.png"><img src="https://raw.githubusercontent.com/chrismckelt/chrismckelt.github.io/master/_posts/posts/images//image.axd?picture=image_thumb_34.png" alt="image" title="image" /></a></p>

<p>Â </p>

<p>Build server process</p>

<p>Â </p>

<p>The build/check-in process is now as follows.</p>

<p>1. Developer checks in.</p>

<p>2. Build server detects changes â€“ cleans everything and then pulls down latest SVN code</p>

<p>3. Cruise control builds code in release mode â€“&gt; If compile fails â€“&gt; build fail</p>

<p>4. Unit tests run in place Ã  if any test fails â€“&gt; build fail</p>

<p>5. On success a new folder with the VERSION number is createdÂ Â Â Â Â  â€” <em>this is our artefacts</em></p>

<p>6. This build is then deployed to the integration server and the Acceptance tests are run â€“ Results are output to a folder</p>

<p>7. If the Acceptance tests fails -&gt; build fail</p>

<p>8. On Success the build is packaged for deployment (config files modified for environment)</p>

<p>Â </p>

<p>Cruise control originally calls default.ps1 passing in the environment.</p>

<powershell> <scriptsDirectory>C:\\CCWorking\\Phoenix\\CodeBase\\Build\\BuildScripts</scriptsDirectory><!--Scrips folder--> <script>default.ps1</script> <buildArgs>-environment:integration</buildArgs><!-- Project working folder -workingDir C:\\project1\\working--> <executable>C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe</executable> <buildTimeoutSeconds>10000</buildTimeoutSeconds> <description>Phoenix Build</description> </powershell>

<p>Â </p>

<p>This calls build.ps1</p>

<p>PSAKE tasks include</p>

<p>Â </p>

<p>Task default -depends PrintInformation, CleanEnvironment, Clean, SetupEnvironment, MakeBuild, BuildDatabase, DeployIntegrationBuild, IntegrationTest, DeployBuild, UpdateConfigFiles</p>

<p>Â </p>

<h1 id="to-run-the-acceptance-tests-using-gallio">To run the acceptance tests using Gallio</h1>

<p>The following Powershell function is used:@</p>

<p><em>Usage for Gallio tests:</em></p>

<p><em>Task Test-System -Description â€œRuns the system tests via Gallioâ€ { Test-Gallio $proj $configuration $platform $dll â€œsystemâ€ â€œTest.Systemâ€ # Test-Gallio â€œ.\src\Test.Unit\Test.Unit.csprojâ€ Release x64 â€œ.\src\Test.Unit\bin\Release\x64\Test.Unit.dllâ€ â€œunitâ€ } } #&gt; function Test-Gallio($proj, $configuration, $platform, $dll, $report_name, $report_dir, $namespace_filter){ Write-Host â€œGALLIO TEST proj â€“Â  $projâ€ Write-Host â€œGALLIO TEST configuration â€“Â  $configurationâ€ Write-Host â€œGALLIO TEST platform â€“Â  $platformâ€ Write-Host â€œGALLIO TEST dll â€“Â  $dllâ€ Write-Host â€œGALLIO TEST report_name â€“Â  $report_nameâ€ Write-Host â€œGALLIO TEST namespace_filter â€“Â  $namespace_filterâ€</em></p>

<table>
  <tbody>
    <tr>
      <td>_if ( (Get-PSSnapin -Name Gallio -ErrorAction SilentlyContinue) -eq $null ) { Add-PSSnapin Gallio } $result = Run-Gallio $dll -filter Namespace:/$namespace_filter/ -ReportTypes text,html,xml -ReportDirectory $report_dirÂ  -ReportNameFormat $report_name-test-reportÂ  #-NoProgress -NoEchoResults get-content â€œ$report_dir\$report_name-test-report.txtâ€</td>
      <td>Write-Host Write-Host $result.ResultsSummary if ($result.Statistics.FailedCount -gt 0) { Write-Warning â€œSome unit tests have failed.â€ $Error = $result.ResultsSummary exit $result.ResultCode }</td>
    </tr>
  </tbody>
</table>

<p>Remove-PSSnapin Gallio</p>

<p>}_</p>

<p>Â </p>

<p>From an acceptance test entered into SpecFlow as follows:</p>

<p><a href="http://www.mckelt.com/image.axd?picture=image_35.png"><img src="https://raw.githubusercontent.com/chrismckelt/chrismckelt.github.io/master/_posts/posts/images//image.axd?picture=image_thumb_35.png" alt="image" title="image" /></a></p>

<p>On checkin the build will run and output the result of this test in a report called <em>AcceptanceTests-test-report.html</em></p>

<p><a href="http://www.mckelt.com/image.axd?picture=image_36.png"><img src="https://raw.githubusercontent.com/chrismckelt/chrismckelt.github.io/master/_posts/posts/images//image.axd?picture=image_thumb_36.png" alt="image" title="image" /></a></p>

<p><a href="http://www.mckelt.com/image.axd?picture=image_37.png"><img src="https://raw.githubusercontent.com/chrismckelt/chrismckelt.github.io/master/_posts/posts/images//image.axd?picture=image_thumb_37.png" alt="image" title="image" /></a></p>
:ET